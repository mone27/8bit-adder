"""API server running on the raspberry to control the adder inputs"""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/00_core.ipynb.

# %% auto #0
__all__ = ['pins_a', 'pins_b', 'pin_sub', 'set_a', 'set_b', 'app', 'dec_to_bin_digits', 'set_number', 'set_add', 'set_sub',
           'api_set_a', 'api_set_b', 'api_set_mode']

# %% ../nbs/00_core.ipynb #b23521be-7d9e-406b-8b41-f85f910f4810
from fastcore.test import *
from functools import partial

# %% ../nbs/00_core.ipynb #53f09fd0
import RPi.GPIO as GPIO
GPIO.setmode(GPIO.BOARD) # numbers from 0 to 40

# %% ../nbs/00_core.ipynb #84ddf06a
pins_a = {
    8: 7,
    7: 11,
    6: 13,
    5: 15,
    4: 19,
    3: 21,
    2: 23,
    1: 29}

# %% ../nbs/00_core.ipynb #91d085b8-1389-46e3-b0d7-fb9f713bbce5
pins_b = {
    8: 32,
    7: 37,
    6: 35,
    5: 33,
    4: 31,
    3: 36,
    2: 38,
    1: 40}

# %% ../nbs/00_core.ipynb #ba89543d-ca5e-45b2-bab9-86a60ecb13d9
pin_sub = 26

# %% ../nbs/00_core.ipynb #b19bb3bc
GPIO.setup(list(pins_a.values()), GPIO.OUT)
GPIO.setup(list(pins_b.values()), GPIO.OUT)
GPIO.setup(pin_sub, GPIO.OUT)

# %% ../nbs/00_core.ipynb #8322a56e-c818-4601-a602-d7ef927b70b1
def dec_to_bin_digits(x):
    """converts decimal to list of 8 binary digits"""
    string = '{0:08b}'.format(x)
    return list(map(int, string))

# %% ../nbs/00_core.ipynb #2873a336-9de7-401a-9329-4b8ee9ab39eb
def set_number(n, pin_map):
    bin_digits = dec_to_bin_digits(n)
    bin_digits.reverse() # need from low bit to high bit
    for i, digit in enumerate(bin_digits):
        GPIO.output(pin_map[i+1], digit)

# %% ../nbs/00_core.ipynb #6e2a6148-d415-498b-bed9-8bd0222b943e
def set_add():
    GPIO.output(pin_sub, 0)
def set_sub():
    GPIO.output(pin_sub, 1)

# %% ../nbs/00_core.ipynb #c6f05a7c-8ea8-4288-9cfb-f3459afbb27d
set_a = partial(set_number, pin_map = pins_a)
set_b = partial(set_number, pin_map = pins_b)

# %% ../nbs/00_core.ipynb #08249486-823b-4e19-8f7a-9557b1bb25c3
from fastapi import FastAPI

app = FastAPI()


@app.get("/set_a/{num}")
async def api_set_a(num: int):
    set_a(num)
    return True
@app.get("/set_b/{num}")
async def api_set_b(num: int):
    set_b(num)
    return True
@app.get("/set_mode/{mode}")
async def api_set_mode(mode: str):
    match mode:
        case "add": set_add()
        case "sub": set_sub()
        case _: raise HTTPException(status_code=400, detail="invalid mode")
    return True

